//##success_test
import "../ustlib/shared_mt/shared_ptr_mt_mut.u"
import "../ustlib/shared_mt/shared_ptr_mt_imut.u"
import "../ustlib/shared_mt/shared_ptr_mt_nullable_mut.u"
import "../ustlib/shared_mt/shared_ptr_mt_nullable_imut.u"

type IntPtrMut=  ust::shared_ptr_mt_mut </i32/>;
type IntPtrImut= ust::shared_ptr_mt_imut</i32/>;
type IntPtrNullableMut=  ust::shared_ptr_mt_nullable_mut </i32/>;
type IntPtrNullableImut= ust::shared_ptr_mt_nullable_imut</i32/>;

fn IsMut( void&  mut r ) : bool
{
	return true ;
}

fn IsMut( void& imut r ) : bool
{
	return false;
}

fn U_Main() : i32
{
	//
	// Common test with "shared_ptr"
	//

	{ // Can create empty nullable pointers.
		var IntPtrNullableMut  empty_ptr_mut ;
		var IntPtrNullableImut empty_ptr_imut;
		halt if( !empty_ptr_mut .empty() );
		halt if( !empty_ptr_imut.empty() );
	}
	{ // Can reset empty nullable pointers.
		var IntPtrNullableMut  mut ptr_mut (5);
		var IntPtrNullableImut mut ptr_imut(7);

		halt if( ptr_mut. lock_mut ().get_ref() != 5 );
		halt if( ptr_imut.lock_imut().get_ref() != 7 );

		ptr_mut.reset ();
		ptr_imut.reset();
		halt if( !ptr_mut. empty() );
		halt if( !ptr_imut.empty() );
	}
	{ // Can modyfy stored value.
		var IntPtrMut ptr(99);
		++ptr.lock_mut().get_ref();
		halt if( ptr.lock_mut ().get_ref() != 100 );
		halt if( ptr.lock_imut().get_ref() != 100 );
	}
	{ // Can share value
		var IntPtrMut ptr0(42);
		auto ptr1= ptr0;

		halt if( ptr0.lock_imut().get_ref() != 42 );
		halt if( ptr1.lock_imut().get_ref() != 42 );

		ptr0.lock_mut().get_ref()= 66;
		halt if( ptr0.lock_imut().get_ref() != 66 );
		halt if( ptr1.lock_imut().get_ref() != 66 );

		--ptr1.lock_mut().get_ref();
		halt if( ptr0.lock_imut().get_ref() != 65 );
		halt if( ptr1.lock_imut().get_ref() != 65 );
	}
	{ // Copy shared ptr, reset src shared ptr.
		var IntPtrNullableMut mut ptr0(9999);
		auto ptr1= ptr0;
		ptr0.reset();

		halt if( !ptr0.empty() );
		halt if(  ptr1.empty() );
		halt if( ptr1.lock_imut().get_ref() != 9999 );
	}
	{ // Copy shared ptr, destroy src shared ptr.
		var IntPtrNullableMut mut ptr0(555);
		auto ptr1= ptr0;
		move(ptr0);

		halt if( ptr1.empty() );
		halt if( ptr1.lock_imut().get_ref() != 555 );
	}
	{ // Reset shared_ptr with new value.
		var IntPtrMut mut ptr0(20);
		auto ptr1= ptr0;

		halt if( ptr0.lock_imut().get_ref() != 20 );
		halt if( ptr1.lock_imut().get_ref() != 20 );

		ptr0.reset( 37 ); // Now, ptr0 and ptr1 have different values.
		halt if( ptr0.lock_imut().get_ref() != 37 );
		halt if( ptr1.lock_imut().get_ref() != 20 );

		ptr1.lock_mut().get_ref()= 91;
		halt if( ptr0.lock_imut().get_ref() != 37 );
		halt if( ptr1.lock_imut().get_ref() != 91 );
	}
	{ // Copy assignment operator.
		var IntPtrNullableMut mut ptr0(56), mut ptr1;
		halt if(  ptr0.empty() );
		halt if( !ptr1.empty() );
		ptr1= ptr0;
		halt if( ptr0.lock_imut().get_ref() != 56 );
		halt if( ptr1.lock_imut().get_ref() != 56 );
		halt if( ust::ref_to_int( ptr0.lock_imut().get_ref() ) != ust::ref_to_int( ptr1.lock_imut().get_ref() ) );
	}
	{ // "lock_mut" and "lock_imut" return "mut" or "imut" references.
		var IntPtrMut ptr(0);

		halt if( IsMut( ptr.lock_imut().get_ref() ) );
		halt if( !IsMut( ptr.lock_mut().get_ref() ) );
	}

	{ // Non-nullable mutable pointer can be converted to nullable mutable pointer.
		var IntPtrMut ptr0(66);
		var IntPtrNullableMut ptr1(ptr0);
		halt if( ust::ref_to_int( ptr1.lock_imut().get_ref() ) != ust::ref_to_int( ptr0.lock_imut().get_ref() ) );
	}
	{ // Non-nullable immutable pointer can be converted to nullable immutable pointer.
		var IntPtrImut ptr0(22);
		var IntPtrNullableImut ptr1(ptr0);
		halt if( ust::ref_to_int( ptr1.lock_imut().get_ref() ) != ust::ref_to_int( ptr0.lock_imut().get_ref() ) );
	}
	{ // Mutable pointer can be converted to immutable pointer.
		var IntPtrMut ptr0(32);
		var IntPtrImut ptr1(ptr0);
		halt if( ust::ref_to_int( ptr1.lock_imut().get_ref() ) != ust::ref_to_int( ptr0.lock_imut().get_ref() ) );
	}
	{ // Mutable nullable pointer can be converted to immutable nullable pointer.
		var IntPtrNullableMut ptr0(94);
		var IntPtrNullableImut ptr1(ptr0);
		halt if( ust::ref_to_int( ptr1.lock_imut().get_ref() ) != ust::ref_to_int( ptr0.lock_imut().get_ref() ) );
	}
	{ // Nullable shared_ptr can be converted to non-nullable shared_ptr
		var IntPtrNullableMut ptr0(35);
		var IntPtrMut ptr1= ust::to_non_nullable(ptr0);
		halt if( ust::ref_to_int( ptr1.lock_imut().get_ref() ) != ust::ref_to_int( ptr0.lock_imut().get_ref() ) );
	}
	{ // Nullable shared_ptr can be converted to non-nullable shared_ptr
		var IntPtrNullableImut ptr0(35);
		var IntPtrImut ptr1= ust::to_non_nullable(ptr0);
		halt if( ust::ref_to_int( ptr1.lock_imut().get_ref() ) != ust::ref_to_int( ptr0.lock_imut().get_ref() ) );
	}

	//
	// shared_ptr_mt-sepcific tests.
	//

	return 0;
}
